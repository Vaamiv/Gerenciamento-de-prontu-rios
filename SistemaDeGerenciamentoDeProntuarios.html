<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Gerenciamento de Prontuários (Offline + Criptografia)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-6">
      <h1 class="text-4xl font-bold text-indigo-800 mb-2 text-center whitespace-nowrap">
        <i class="fas fa-file-medical mr-3"></i>Sistema de Gerenciamento de Prontuários HSP
      </h1>
      <p class="text-gray-600">Gerencie prontuários médicos de forma eficiente e organizada</p>
    </div>

    <!-- Ações topo -->
    <div class="flex justify-center gap-2 mb-8">
      <button id="btnExport" class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition flex items-center gap-2" title="Exportar backup (.zip)">
        <i class="fa-solid fa-file-export"></i><span class="hidden sm:inline">Exportar</span>
      </button>

      <label class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition flex items-center gap-2 cursor-pointer" title="Importar backup (.zip)">
        <i class="fa-solid fa-file-import"></i><span class="hidden sm:inline">Importar</span>
        <input id="inputImport" type="file" accept=".zip" class="hidden"/>
      </label>

      <button id="btnBackupDir" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50" title="Configurar pasta de backup">
        <i class="fa-solid fa-folder-open mr-2"></i>Pasta de backup
      </button>

      <!-- NOVO: alterar senha -->
      <button id="btnChangePw" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50" title="Alterar senha">
        <i class="fa-solid fa-key mr-2"></i>Alterar senha
      </button>

      <button id="btnLock" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50" title="Bloquear">
        <i class="fa-solid fa-lock mr-2"></i>Bloquear
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex justify-center mb-8">
      <div class="bg-white rounded-lg shadow-md p-1">
        <button id="addTab" class="px-6 py-3 rounded-md font-medium transition-all duration-200 bg-indigo-600 text-white">
          <i class="fas fa-plus mr-2"></i>Adicionar Prontuário
        </button>
        <button id="consultTab" class="px-6 py-3 rounded-md font-medium transition-all duration-200 text-indigo-600 hover:bg-indigo-50">
          <i class="fas fa-search mr-2"></i>Consultar Pacientes
        </button>
      </div>
    </div>

    <!-- Adicionar -->
    <div id="addSection" class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
          <i class="fas fa-user-plus mr-2 text-indigo-600"></i>Novo Prontuário
        </h2>

        <form id="recordForm" class="space-y-6" autocomplete="off">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" for="patientName"><i class="fas fa-user mr-1"></i>Nome do Paciente</label>
            <input type="text" id="patientName" required maxlength="120"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              placeholder="Nome completo">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" for="appointmentDate"><i class="fas fa-calendar mr-1"></i>Data do atendimento</label>
            <input type="date" id="appointmentDate" required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" for="appointmentType"><i class="fas fa-stethoscope mr-1"></i>Tipo do atendimento</label>
            <select id="appointmentType" required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <option value="">Selecione</option>
              <option>FAA</option>
              <option>Internação</option>
              <option>Oftalmologia</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" for="category"><i class="fas fa-tags mr-1"></i>Categoria</label>
            <select id="category" required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <option value="">Selecione</option>
              <option>SUS</option>
              <option>Particular HSP</option>
              <option>IPE</option>
              <option>PM Lagoa</option>
              <option>Unimed</option>
              <option>Outros</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-file-pdf mr-1"></i>Arquivo PDF</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400">
              <input type="file" id="pdfFile" accept=".pdf" required class="hidden">
              <div id="fileDropZone" class="cursor-pointer" aria-label="Selecione ou arraste o PDF">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">Clique para selecionar ou arraste o PDF aqui</p>
                <p class="text-sm text-gray-400 mt-1">Apenas PDF</p>
              </div>
              <div id="fileInfo" class="hidden">
                <i class="fas fa-file-pdf text-red-500 text-2xl mb-2"></i>
                <p id="fileName" class="text-gray-700 font-medium"></p>
                <button type="button" id="removeFile" class="text-red-500 hover:text-red-700 text-sm mt-1">
                  <i class="fas fa-times mr-1"></i>Remover arquivo
                </button>
              </div>
            </div>
          </div>

        <button type="submit"
          class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-105">
          <i class="fas fa-save mr-2"></i>Registrar Prontuário
        </button>
        </form>
      </div>
    </div>

    <!-- Consultar -->
    <div id="consultSection" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-search mr-2 text-indigo-600"></i>Consultar Pacientes</h2>

        <!-- Filtros -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
          <div class="md:col-span-2">
            <div class="relative">
              <input type="text" id="searchInput"
                class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                placeholder="Buscar por nome, tipo, categoria...">
              <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
          </div>
          <div>
            <select id="filterType" class="w-full px-3 py-3 border rounded-lg" title="Tipo">
              <option value="">Tipo (todos)</option>
              <option>FAA</option>
              <option>Internação</option>
              <option>Oftalmologia</option>
            </select>
          </div>
          <div>
            <select id="filterCategory" class="w-full px-3 py-3 border rounded-lg" title="Categoria">
              <option value="">Categoria (todas)</option>
              <option>SUS</option>
              <option>Particular HSP</option>
              <option>IPE</option>
              <option>PM Lagoa</option>
              <option>Unimed</option>
              <option>Outros</option>
            </select>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div class="text-sm text-gray-600" id="statsInfo">—</div>
          <div class="flex gap-2">
            <button id="btnClearFilters" class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-lg border">Limpar filtros</button>
            <button id="btnSort" class="px-3 py-2 rounded-lg border bg-gray-50 hover:bg-gray-100" title="Alternar ordenação">
              <i class="fa-solid fa-arrow-down-short-wide mr-1"></i><span id="sortLabel">Mais recentes</span>
            </button>
          </div>
        </div>

        <div id="recordsList">
          <div id="noRecords" class="text-center py-12">
            <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">Nenhum prontuário encontrado</p>
            <p class="text-gray-400">Adicione prontuários para visualizá-los aqui</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal sucesso -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md mx-4">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
          <i class="fas fa-check text-green-600 text-xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Prontuário Registrado!</h3>
        <p class="text-gray-600 mb-6">Deseja adicionar outro para o mesmo paciente?</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button id="modalAddAnother" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-indigo-700">Adicionar outro</button>
          <button id="modalFinish" class="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-medium hover:bg-gray-300">Concluir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal edição -->
  <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fa-solid fa-pen-to-square mr-2 text-indigo-600"></i>Editar Prontuário
      </h3>
      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="editPatientName">Nome do paciente</label>
          <input id="editPatientName" type="text" class="w-full px-3 py-2 border rounded-lg" required maxlength="120">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="editAppointmentDate">Data do atendimento</label>
            <input id="editAppointmentDate" type="date" class="w-full px-3 py-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="editAppointmentType">Tipo do atendimento</label>
            <select id="editAppointmentType" class="w-full px-3 py-2 border rounded-lg" required>
              <option>FAA</option><option>Internação</option><option>Oftalmologia</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="editCategory">Categoria</label>
            <select id="editCategory" class="w-full px-3 py-2 border rounded-lg" required>
              <option>SUS</option><option>Particular HSP</option><option>IPE</option>
              <option>PM Lagoa</option><option>Unimed</option><option>Outros</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Substituir PDF (opcional)</label>
          <input id="editPdf" type="file" accept=".pdf" class="w-full">
          <p class="text-xs text-gray-500 mt-1">Sem novo arquivo = mantém o atual.</p>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="editCancel" class="px-4 py-2 rounded-lg border">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal ALTERAR SENHA -->
  <div id="pwModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fa-solid fa-key mr-2 text-indigo-600"></i>Alterar senha
      </h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Senha atual</label>
          <input id="currPw" type="password" class="w-full px-3 py-2 border rounded-lg" autocomplete="current-password">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nova senha</label>
          <input id="newPw" type="password" class="w-full px-3 py-2 border rounded-lg" autocomplete="new-password">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar nova senha</label>
          <input id="newPw2" type="password" class="w-full px-3 py-2 border rounded-lg" autocomplete="new-password">
        </div>
      </div>
      <div class="flex justify-end gap-2 pt-4">
        <button id="pwCancel" class="px-4 py-2 rounded-lg border">Cancelar</button>
        <button id="pwSave" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Os arquivos serão recriptografados com a nova senha neste dispositivo.</p>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-[9999] pointer-events-none"></div>

  <!-- Tela de autenticação -->
  <div id="authScreen" class="fixed inset-0 bg-indigo-50/80 backdrop-blur-sm z-[10000] hidden items-center justify-center px-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
      <div class="text-center mb-4">
        <h2 class="text-2xl font-bold text-indigo-700">Acesso</h2>
        <p class="text-gray-500 text-sm">Proteja seus prontuários neste dispositivo</p>
      </div>
      <!-- Setup -->
      <div id="authStepSetup" class="hidden">
        <label class="block text-sm font-medium mb-1">Crie uma senha</label>
        <input id="authNewPw" type="password" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Mínimo 6 caracteres" autocomplete="new-password" autocapitalize="off" autocorrect="off" spellcheck="false">
        <label class="block text-sm font-medium mb-1">Repita a senha</label>
        <input id="authNewPw2" type="password" class="w-full border rounded-lg px-3 py-2 mb-4" autocomplete="new-password" autocapitalize="off" autocorrect="off" spellcheck="false">
        <button id="authSetupBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Salvar senha</button>
        <p class="text-xs text-gray-500 mt-3">A senha fica só neste navegador. Guarde um backup do app regularmente.</p>
      </div>
      <!-- Login -->
      <div id="authStepLogin" class="hidden">
        <label class="block text-sm font-medium mb-1">Senha</label>
        <input id="authPw" type="password" class="w-full border rounded-lg px-3 py-2 mb-4" placeholder="Digite sua senha" autocomplete="current-password" autocapitalize="off" autocorrect="off" spellcheck="false">
        <button id="authLoginBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Entrar</button>
        <p class="text-xs text-gray-500 mt-3">Esqueceu? Limpe o navegador e reimporte um backup.</p>
      </div>
    </div>
  </div>

  <script>
    /* ====================== UTIL/CRYPTO (AES-GCM + PBKDF2) ===================== */
    const AUTH_SALT_KEY = 'auth.salt';
    const AUTH_VERIF_KEY = 'auth.verifier';
    const AUTH_ITERS = 150000; // PBKDF2 iterações
    const ENC = { key: null };

    const te = new TextEncoder();
    const td = new TextDecoder();

    const b64 = (u8) => btoa(String.fromCharCode(...u8));
    const b64dec = (b) => new Uint8Array([...atob(b)].map(c => c.charCodeAt(0)));
    async function sha256(data) {
      return new Uint8Array(await crypto.subtle.digest('SHA-256', data));
    }
    async function kdf(password, saltU8) {
      const baseKey = await crypto.subtle.importKey('raw', te.encode(password), 'PBKDF2', false, ['deriveBits']);
      const bits = await crypto.subtle.deriveBits({ name: 'PBKDF2', hash: 'SHA-256', salt: saltU8, iterations: AUTH_ITERS }, baseKey, 256);
      return new Uint8Array(bits);
    }
    async function importAesKey(raw) {
      return crypto.subtle.importKey('raw', raw, { name: 'AES-GCM' }, false, ['encrypt','decrypt']);
    }
    async function setPassword(pw) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const keyRaw = await kdf(pw, salt);
      const verif = await sha256(keyRaw);
      localStorage.setItem(AUTH_SALT_KEY, b64(salt));
      localStorage.setItem(AUTH_VERIF_KEY, b64(verif));
      ENC.key = await importAesKey(keyRaw);
    }
    async function checkPassword(pw) {
      const saltB64 = localStorage.getItem(AUTH_SALT_KEY);
      const verifB64 = localStorage.getItem(AUTH_VERIF_KEY);
      if (!saltB64 || !verifB64) return false;
      const keyRaw = await kdf(pw, b64dec(saltB64));
      const ok = b64(await sha256(keyRaw)) === verifB64;
      if (ok) ENC.key = await importAesKey(keyRaw);
      return ok;
    }
    async function encryptBytes(plainU8) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = new Uint8Array(await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, ENC.key, plainU8));
      return { iv, ct };
    }
    async function decryptBytes(ivU8, ctU8) {
      const pt = new Uint8Array(await crypto.subtle.decrypt({ name: 'AES-GCM', iv: ivU8 }, ENC.key, ctU8));
      return pt;
    }
    // Helpers para chave explícita (para alterar senha)
    async function encryptBytesWithKey(aesKey, plainU8) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = new Uint8Array(await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, plainU8));
      return { iv, ct };
    }
    async function decryptBytesWithKey(aesKey, ivU8, ctU8) {
      const pt = new Uint8Array(await crypto.subtle.decrypt({ name: 'AES-GCM', iv: ivU8 }, aesKey, ctU8));
      return pt;
    }

    /* ====================== INDEXEDDB ===================== */
    const DB_NAME = 'medicalDB';
    const DB_VERSION = 3; // inclui store 'settings'
    const STORE = 'records';

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          let os = db.objectStoreNames.contains(STORE)
            ? req.transaction.objectStore(STORE)
            : db.createObjectStore(STORE, { keyPath: 'id' });
          for (const key of ['patientName', 'appointmentDate', 'appointmentType', 'category']) {
            if (!os.indexNames.contains(key)) os.createIndex(key, key, { unique: false });
          }
          if (!db.objectStoreNames.contains('settings')) {
            db.createObjectStore('settings', { keyPath: 'key' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function dbAddRecord(record) { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE, 'readwrite'); tx.oncomplete = () => res(true); tx.onerror = () => rej(tx.error); tx.objectStore(STORE).add(record); }); }
    async function dbUpdateRecord(record) { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE, 'readwrite'); tx.oncomplete = () => res(true); tx.onerror = () => rej(tx.error); tx.objectStore(STORE).put(record); }); }
    async function dbGetAll() { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE, 'readonly'); const req = tx.objectStore(STORE).getAll(); req.onsuccess = () => res(req.result || []); req.onerror = () => rej(req.error); }); }
    async function dbGetById(maybeId) {
      const db = await openDB();
      return new Promise((res) => {
        const tx = db.transaction(STORE, 'readonly');
        const store = tx.objectStore(STORE);
        const tryNumber = !Number.isNaN(Number(maybeId)) && maybeId !== '' ? Number(maybeId) : null;
        const req1 = store.get(maybeId);
        req1.onsuccess = () => {
          if (req1.result) return res(req1.result);
          if (tryNumber !== null) {
            const req2 = store.get(tryNumber);
            req2.onsuccess = () => res(req2.result || null);
            req2.onerror = () => res(null);
          } else res(null);
        };
        req1.onerror = () => res(null);
      });
    }
    // settings
    async function settingsSet(key, value) {
      try { const db = await openDB(); return new Promise((res, rej) => {
        const tx = db.transaction('settings', 'readwrite'); tx.oncomplete = () => res(true); tx.onerror = () => rej(tx.error);
        tx.objectStore('settings').put({ key, value });
      }); } catch { return false; }
    }
    async function settingsGet(key) {
      try { const db = await openDB(); return new Promise((res, rej) => {
        const tx = db.transaction('settings', 'readonly'); const req = tx.objectStore('settings').get(key);
        req.onsuccess = () => res(req.result ? req.result.value : null); req.onerror = () => rej(req.error);
      }); } catch { return null; }
    }

    /* ====================== HELPERS UI ===================== */
    function todayISO() { const t = new Date(); return `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')}`; }
    function formatISOToBR(iso) { if (!iso || !iso.includes('-')) return iso || ''; const [y, m, d] = iso.split('-'); return `${d.padStart(2, '0')}/${m.padStart(2, '0')}/${y}`; }
    function normalizeStr(s) { return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim(); }
    function showToast(msg, type = 'success') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = 'pointer-events-auto flex items-center px-4 py-3 rounded-lg shadow-lg text-white transition-opacity opacity-0 ' + (type === 'success' ? 'bg-green-600' : 'bg-red-600');
      t.innerHTML = '<i class="fas ' + (type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle') + ' mr-2"></i><span>' + msg + '</span>';
      c.appendChild(t);
      requestAnimationFrame(() => t.classList.remove('opacity-0'));
      setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.remove(), 500); }, 3500);
    }
    function showUndoToast(msg, onUndo) {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = 'pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg text-white bg-green-600 transition-opacity opacity-0';
      t.innerHTML = `<i class="fas fa-check-circle"></i><span>${msg}</span>
                     <button class="ml-2 underline font-medium">Desfazer</button>`;
      const btn = t.querySelector('button');
      btn.addEventListener('click', () => { try { onUndo?.(); } finally { t.remove(); } });
      c.appendChild(t);
      requestAnimationFrame(() => t.classList.remove('opacity-0'));
      setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.remove(), 500); }, 6000);
    }

    /* ====================== ELEMENTOS ===================== */
    const addTab = document.getElementById('addTab');
    const consultTab = document.getElementById('consultTab');
    const addSection = document.getElementById('addSection');
    const consultSection = document.getElementById('consultSection');

    const recordForm = document.getElementById('recordForm');
    const modal = document.getElementById('modal');
    const modalAddAnother = document.getElementById('modalAddAnother');
    const modalFinish = document.getElementById('modalFinish');

    const fileDropZone = document.getElementById('fileDropZone');
    const pdfFile = document.getElementById('pdfFile');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const removeFile = document.getElementById('removeFile');

    const searchInput = document.getElementById('searchInput');
    const filterType = document.getElementById('filterType');
    const filterCategory = document.getElementById('filterCategory');
    const btnClearFilters = document.getElementById('btnClearFilters');
    const btnSort = document.getElementById('btnSort');
    const sortLabel = document.getElementById('sortLabel');
    const statsInfo = document.getElementById('statsInfo');

    const btnExport = document.getElementById('btnExport');
    const inputImport = document.getElementById('inputImport');
    const btnLock = document.getElementById('btnLock');
    const btnBackupDir = document.getElementById('btnBackupDir');
    const btnChangePw = document.getElementById('btnChangePw');

    // Modal alterar senha
    const pwModal = document.getElementById('pwModal');
    const currPw = document.getElementById('currPw');
    const newPw = document.getElementById('newPw');
    const newPw2 = document.getElementById('newPw2');
    const pwSave = document.getElementById('pwSave');
    const pwCancel = document.getElementById('pwCancel');

    /* ====================== AUTH (tela + lock) ===================== */
    const authScreen = document.getElementById('authScreen');
    const authStepSetup = document.getElementById('authStepSetup');
    const authStepLogin = document.getElementById('authStepLogin');
    const authNewPw = document.getElementById('authNewPw');
    const authNewPw2 = document.getElementById('authNewPw2');
    const authSetupBtn = document.getElementById('authSetupBtn');
    const authPw = document.getElementById('authPw');
    const authLoginBtn = document.getElementById('authLoginBtn');

    function lock() {
      sessionStorage.removeItem('auth.ok');
      ENC.key = null;
      for (const id of ['authPw','authNewPw','authNewPw2']) {
        const el = document.getElementById(id);
        if (el) { el.value = ''; el.setAttribute('value', ''); }
      }
      authStepLogin.classList.remove('hidden');
      authStepSetup.classList.add('hidden');
      authScreen.classList.remove('hidden');
      authScreen.classList.add('flex');
      setTimeout(() => authPw?.focus(), 0);
    }
    function unlock() {
      sessionStorage.setItem('auth.ok','1');
      for (const id of ['authPw','authNewPw','authNewPw2']) {
        const el = document.getElementById(id);
        if (el) { el.value = ''; el.setAttribute('value', ''); }
      }
      authScreen.classList.add('hidden');
      authScreen.classList.remove('flex');
    }
    function togglePwModal(show) {
      if (show) { pwModal.classList.remove('hidden'); pwModal.classList.add('flex'); currPw.value=''; newPw.value=''; newPw2.value=''; }
      else { pwModal.classList.add('hidden'); pwModal.classList.remove('flex'); }
    }

    /* ====================== INICIALIZAÇÃO ===================== */
    // ordenação cíclica: recent -> oldest -> az -> za
    let sortMode = 'recent';
    // pasta de backup (Chromium)
    let backupDirHandle = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (authPw) authPw.name = 'pw_' + Math.random().toString(36).slice(2);

      authScreen.classList.add('flex'); authScreen.classList.remove('hidden');
      if (localStorage.getItem(AUTH_SALT_KEY) && localStorage.getItem(AUTH_VERIF_KEY)) {
        authStepLogin.classList.remove('hidden');
      } else {
        authStepSetup.classList.remove('hidden');
      }

      try { const h = await settingsGet('backupDirHandle'); if (h) backupDirHandle = h; } catch {}
      document.getElementById('appointmentDate').value = todayISO();
      await displayRecords();
    });

    document.addEventListener('click', async (e) => {
      const id = e.target?.id;

      if (id === 'authSetupBtn') {
        if (authNewPw.value.length < 6) return alert('Use pelo menos 6 caracteres.');
        if (authNewPw.value !== authNewPw2.value) return alert('As senhas não conferem.');
        await setPassword(authNewPw.value);
        unlock();
      }

      if (id === 'authLoginBtn') {
        const ok = await checkPassword(authPw.value);
        if (!ok) return alert('Senha incorreta.');
        unlock();
      }

      if (id === 'btnLock') lock();

      if (id === 'btnChangePw') togglePwModal(true);
      if (id === 'pwCancel') togglePwModal(false);
    });

    // salvar nova senha
    pwSave.addEventListener('click', async () => {
      const c = currPw.value || '';
      const n1 = newPw.value || '';
      const n2 = newPw2.value || '';
      if (!c || !n1 || !n2) return alert('Preencha todos os campos.');
      if (n1.length < 6) return alert('Nova senha: mínimo 6 caracteres.');
      if (n1 !== n2) return alert('As novas senhas não conferem.');

      // verifica senha atual e obtém chave antiga
      const saltB64 = localStorage.getItem(AUTH_SALT_KEY);
      const verifB64 = localStorage.getItem(AUTH_VERIF_KEY);
      if (!saltB64 || !verifB64) return alert('Nenhuma senha configurada.');

      const oldRaw = await kdf(c, b64dec(saltB64));
      const ok = b64(await sha256(oldRaw)) === verifB64;
      if (!ok) return alert('Senha atual incorreta.');

      const oldKey = await importAesKey(oldRaw);

      // deriva nova chave e novo salt
      const newSalt = crypto.getRandomValues(new Uint8Array(16));
      const newRaw = await kdf(n1, newSalt);
      const newKey = await importAesKey(newRaw);

      // recriptografa todos os registros
      pwSave.disabled = true; pwSave.textContent = 'Processando...';
      try {
        const all = await dbGetAll();
        for (const rec of all) {
          if (!rec.fileBlob) continue;
          let pt;
          if (rec.fileIv) {
            // decrypt com chave antiga
            try {
              const ct = new Uint8Array(await rec.fileBlob.arrayBuffer());
              const iv = b64dec(rec.fileIv);
              pt = await decryptBytesWithKey(oldKey, iv, ct);
            } catch (e) {
              console.error('Erro ao descriptografar', rec.id, e);
              continue; // pula registro corrompido
            }
          } else {
            // legado sem crypto -> usa o blob como plaintext
            pt = new Uint8Array(await rec.fileBlob.arrayBuffer());
          }
          // encrypt com chave nova
          const enc = await encryptBytesWithKey(newKey, pt);
          rec.fileBlob = new Blob([enc.ct], { type: 'application/octet-stream' });
          rec.fileIv = b64(enc.iv);
          rec.fileMime = rec.fileMime || 'application/pdf';
          await dbUpdateRecord(rec);
        }

        // troca salt/verifier e chave ativa
        localStorage.setItem(AUTH_SALT_KEY, b64(newSalt));
        localStorage.setItem(AUTH_VERIF_KEY, b64(await sha256(newRaw)));
        ENC.key = newKey;

        togglePwModal(false);
        showToast('Senha alterada e arquivos recriptografados.');
      } catch (e) {
        console.error(e);
        alert('Falha ao alterar a senha. Veja o console para detalhes.');
      } finally {
        pwSave.disabled = false; pwSave.textContent = 'Salvar';
      }
    });

    // Auto-bloqueio em 10min
    ;['click','keydown','mousemove','touchstart','scroll'].forEach(evt => {
      let t; document.addEventListener(evt, () => { clearTimeout(t); t = setTimeout(lock, 10 * 60 * 1000); }, { passive: true });
    });

    /* ====================== Tabs ===================== */
    addTab.addEventListener('click', () => {
      addTab.classList.add('bg-indigo-600','text-white');
      addTab.classList.remove('text-indigo-600','hover:bg-indigo-50');
      consultTab.classList.remove('bg-indigo-600','text-white');
      consultTab.classList.add('text-indigo-600','hover:bg-indigo-50');
      addSection.classList.remove('hidden');
      consultSection.classList.add('hidden');
    });
    consultTab.addEventListener('click', async () => {
      consultTab.classList.add('bg-indigo-600','text-white');
      consultTab.classList.remove('text-indigo-600','hover:bg-indigo-50');
      addTab.classList.remove('bg-indigo-600','text-white');
      addTab.classList.add('text-indigo-600','hover:bg-indigo-50');
      consultSection.classList.remove('hidden');
      addSection.classList.add('hidden');
      await displayRecords();
    });

    /* ====================== Upload PDF ===================== */
    fileDropZone.addEventListener('click', () => pdfFile.click());
    fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); fileDropZone.classList.add('border-indigo-400','bg-indigo-50'); });
    fileDropZone.addEventListener('dragleave', () => { fileDropZone.classList.remove('border-indigo-400','bg-indigo-50'); });
    fileDropZone.addEventListener('drop', (e) => {
      e.preventDefault(); fileDropZone.classList.remove('border-indigo-400','bg-indigo-50');
      const files = e.dataTransfer.files; if (files.length > 0) validateAndSetFile(files[0]);
    });
    pdfFile.addEventListener('change', (e) => { if (e.target.files.length > 0) validateAndSetFile(e.target.files[0]); });
    removeFile.addEventListener('click', () => { pdfFile.value = ''; hideFileInfo(); });

    function validateAndSetFile(file) {
      const isPdf = (file.type === 'application/pdf') || file.name.toLowerCase().endsWith('.pdf');
      if (!isPdf) { alert('Apenas PDF.'); return; }
      showFileInfo(file);
      if (!pdfFile.files || pdfFile.files.length === 0) {
        const dt = new DataTransfer(); dt.items.add(file); pdfFile.files = dt.files;
      }
    }
    function showFileInfo(file) { fileName.textContent = `${file.name}`; fileDropZone.classList.add('hidden'); fileInfo.classList.remove('hidden'); }
    function hideFileInfo() { fileDropZone.classList.remove('hidden'); fileInfo.classList.add('hidden'); }

    /* ====================== SUBMIT (ADD) ===================== */
    recordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!ENC.key) return alert('Desbloqueie com a senha para continuar.');

      const file = pdfFile.files[0]; if (!file) return alert('Selecione um PDF.');
      const patientName = document.getElementById('patientName').value.trim();
      const appointmentDate = document.getElementById('appointmentDate').value;
      const appointmentType = document.getElementById('appointmentType').value;
      const category = document.getElementById('category').value;
      if (!patientName || !appointmentDate || !appointmentType || !category) return alert('Preencha todos os campos.');

      const buf = new Uint8Array(await file.arrayBuffer());
      const enc = await encryptBytes(buf);

      const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + '-' + Math.random().toString(16).slice(2));
      const record = {
        id, patientName, appointmentDate, appointmentType, category,
        fileName: file.name, fileMime: 'application/pdf',
        fileIv: b64(enc.iv), fileBlob: new Blob([enc.ct], { type: 'application/octet-stream' }),
        createdAt: new Date().toISOString()
      };
      try { await dbAddRecord(record); showModal(); }
      catch (err) { console.error(err); showToast('Erro ao salvar: ' + (err?.message || err), 'error'); }
    });

    function showModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
    function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    function resetForm({ keepName = false } = {}) {
      const nameVal = document.getElementById('patientName').value;
      recordForm.reset(); document.getElementById('appointmentDate').value = todayISO(); hideFileInfo();
      if (keepName) { document.getElementById('patientName').value = nameVal; document.getElementById('appointmentType').value = ''; document.getElementById('category').value = ''; }
    }
    async function finalizeAndToast() {
      hideModal(); resetForm({ keepName: false }); showToast('Prontuário salvo com sucesso!', 'success');
      if (!consultSection.classList.contains('hidden')) await displayRecords();
    }
    modalAddAnother.addEventListener('click', async () => {
      hideModal(); resetForm({ keepName: true }); document.getElementById('appointmentType').focus();
      showToast('Prontuário salvo com sucesso!', 'success'); if (!consultSection.classList.contains('hidden')) await displayRecords();
    });
    modalFinish.addEventListener('click', finalizeAndToast);
    modal.addEventListener('click', (e) => { if (e.target === modal) finalizeAndToast(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) finalizeAndToast(); });

    /* ====================== LISTAGEM / FILTROS ===================== */
    ;[searchInput, filterType, filterCategory].forEach(el => {
      el?.addEventListener('input', async () => displayRecords());
      el?.addEventListener('change', async () => displayRecords());
    });
    btnClearFilters.addEventListener('click', async () => {
      searchInput.value = ''; filterType.value = ''; filterCategory.value = ''; await displayRecords();
    });
    btnSort.addEventListener('click', async () => {
      sortMode = sortMode === 'recent' ? 'oldest' : sortMode === 'oldest' ? 'az' : sortMode === 'az' ? 'za' : 'recent';
      sortLabel.textContent = sortMode === 'recent' ? 'Mais recentes' : sortMode === 'oldest' ? 'Mais antigos' : sortMode === 'az' ? 'A–Z' : 'Z–A';
      await displayRecords();
    });

    async function displayRecords() {
      const recordsList = document.getElementById('recordsList');
      const noRecords = document.getElementById('noRecords');
      const records = await dbGetAll();

      const term = normalizeStr(searchInput?.value || '');
      const fType = filterType.value;
      const fCat = filterCategory.value;

      const filtered = records
        .filter(r => !r.deletedAt)
        .filter(r => {
          const nameN = normalizeStr(r.patientName);
          const typeN = normalizeStr(r.appointmentType);
          const catN  = normalizeStr(r.category);
          const termOk = !term || nameN.includes(term) || typeN.includes(term) || catN.includes(term);
          const typeOk = !fType || r.appointmentType === fType;
          const catOk  = !fCat || r.category === fCat;
          return termOk && typeOk && catOk;
        });

      const totalActive = records.filter(r => !r.deletedAt).length;
      statsInfo.textContent = `${filtered.length} prontuário(s) (de ${totalActive})`;

      if (filtered.length === 0) {
        noRecords?.classList.remove('hidden');
        recordsList.querySelectorAll('.patient-block').forEach(n => n.remove());
        return;
      } else noRecords?.classList.add('hidden');

      const grouped = {};
      for (const r of filtered) { (grouped[r.patientName] ??= []).push(r); }

      const groups = Object.entries(grouped).map(([name, arr]) => {
        arr.sort((a,b) => (b.appointmentDate||'').localeCompare(a.appointmentDate||''));
        const keyDate = arr[0]?.appointmentDate || '';
        return { name, arr, keyDate };
      });

      if (sortMode === 'recent' || sortMode === 'oldest') {
        groups.sort((g1, g2) => (sortMode === 'recent'
          ? (g2.keyDate||'').localeCompare(g1.keyDate||'')
          : (g1.keyDate||'').localeCompare(g2.keyDate||'')));
      } else {
        groups.sort((g1, g2) => (sortMode === 'az'
          ? g1.name.localeCompare(g2.name, 'pt-BR')
          : g2.name.localeCompare(g1.name, 'pt-BR')));
      }

      recordsList.innerHTML = noRecords ? noRecords.outerHTML : '';
      noRecords && recordsList.querySelector('#noRecords').classList.add('hidden');

      let html = '';
      for (const g of groups) {
        html += `
          <div class="patient-block mb-8 border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-indigo-50 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-indigo-800"><i class="fas fa-user mr-2"></i>${g.name}</h3>
                <p class="text-sm text-indigo-600">${g.arr.length} prontuário(s)</p>
              </div>
            </div>
            <div class="divide-y divide-gray-200">`;

        for (const r of g.arr) {
          const formattedDate = formatISOToBR(r.appointmentDate);
          const rid = String(r.id).replace(/"/g, '&quot;');
          html += `
            <div class="p-6 hover:bg-gray-50 transition-colors duration-200">
              <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                <div class="flex-1">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                    <div><span class="text-sm font-medium text-gray-500">Data:</span><p class="text-gray-900">${formattedDate}</p></div>
                    <div><span class="text-sm font-medium text-gray-500">Tipo:</span><p class="text-gray-900">${r.appointmentType}</p></div>
                    <div><span class="text-sm font-medium text-gray-500">Categoria:</span><p class="text-gray-900">${r.category}</p></div>
                  </div>
                  <div class="flex items-center text-sm text-gray-600"><i class="fas fa-file-pdf text-red-500 mr-2"></i><span>${r.fileName}</span></div>
                </div>
                <div class="md:ml-4 flex items-center gap-2 flex-wrap">
                  <button class="bg-white border text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors duration-200 flex items-center" data-action="preview" data-id="${rid}">
                    <i class="fa-regular fa-eye mr-2"></i>Visualizar
                  </button>
                  <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors duration-200 flex items-center" data-action="download" data-id="${rid}">
                    <i class="fas fa-download mr-2"></i>Download
                  </button>
                  <button class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 transition-colors duration-200 flex items-center" data-action="edit" data-id="${rid}">
                    <i class="fa-solid fa-pen mr-2"></i>Editar
                  </button>
                  <button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200 flex items-center" data-action="delete" data-id="${rid}">
                    <i class="fas fa-trash-alt mr-2"></i>Remover
                  </button>
                </div>
              </div>
            </div>`;
        }

        html += `</div></div>`;
      }

      recordsList.insertAdjacentHTML('beforeend', html);

      recordsList.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const action = e.currentTarget.getAttribute('data-action');
          if (action === 'preview')  return previewPDF(id);
          if (action === 'download') return downloadPDF(id);
          if (action === 'delete')   return moveToTrash(id);
          if (action === 'edit')     return openEditModal(id);
        });
      });
    }

    /* ====================== PREVIEW / DOWNLOAD / DELETE / EDIT ===================== */
    async function previewPDF(recordId) {
      const rec = await dbGetById(recordId);
      if (!rec || !rec.fileBlob) return showToast('Arquivo não encontrado.', 'error');

      let blobToOpen = rec.fileBlob;
      if (rec.fileIv) {
        if (!ENC.key) return alert('Desbloqueie com a senha para visualizar.');
        try {
          const ct = new Uint8Array(await rec.fileBlob.arrayBuffer());
          const iv = b64dec(rec.fileIv);
          const pt = await decryptBytes(iv, ct);
          blobToOpen = new Blob([pt], { type: rec.fileMime || 'application/pdf' });
        } catch (e) { console.error(e); return showToast('Falha ao descriptografar.', 'error'); }
      }
      const url = URL.createObjectURL(blobToOpen);
      window.open(url, '_blank', 'noopener');
      setTimeout(()=> URL.revokeObjectURL(url), 60000);
    }

    async function downloadPDF(recordId) {
      const rec = await dbGetById(recordId);
      if (!rec || !rec.fileBlob) return showToast('Arquivo não encontrado.', 'error');

      if (!rec.fileIv) {
        const url = URL.createObjectURL(rec.fileBlob);
        const a = document.createElement('a'); a.href = url; a.download = rec.fileName || 'prontuario.pdf';
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(url), 2000);
        return;
      }

      if (!ENC.key) return alert('Desbloqueie com a senha para baixar.');
      try {
        const ct = new Uint8Array(await rec.fileBlob.arrayBuffer());
        const iv = b64dec(rec.fileIv);
        const pt = await decryptBytes(iv, ct);
        const blob = new Blob([pt], { type: rec.fileMime || 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = rec.fileName || 'prontuario.pdf';
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(url), 2000);
      } catch (e) {
        console.error(e); showToast('Falha ao descriptografar.', 'error');
      }
    }

    async function moveToTrash(id) {
      const rec = await dbGetById(id);
      if (!rec) return showToast('Registro não encontrado.', 'error');
      const ok = confirm(`Mover para a lixeira o prontuário de "${rec.patientName}" (${rec.fileName})?`);
      if (!ok) return;
      rec.deletedAt = new Date().toISOString();
      await dbUpdateRecord(rec);
      showUndoToast('Movido para a lixeira.', async () => {
        const r = await dbGetById(rec.id);
        if (r) { delete r.deletedAt; await dbUpdateRecord(r); }
        await displayRecords();
        showToast('Restauração concluída.');
      });
      await displayRecords();
    }

    // Editar
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const editCancel = document.getElementById('editCancel');
    const editId = document.getElementById('editId');
    const editPatientName = document.getElementById('editPatientName');
    const editAppointmentDate = document.getElementById('editAppointmentDate');
    const editAppointmentType = document.getElementById('editAppointmentType');
    const editCategory = document.getElementById('editCategory');
    const editPdf = document.getElementById('editPdf');

    function toggleEditModal(show) { if (show) { editModal.classList.remove('hidden'); editModal.classList.add('flex'); } else { editModal.classList.add('hidden'); editModal.classList.remove('flex'); } }
    async function openEditModal(id) {
      const rec = await dbGetById(id); if (!rec) return showToast('Registro não encontrado.', 'error');
      editId.value = rec.id; editPatientName.value = rec.patientName || '';
      editAppointmentDate.value = rec.appointmentDate || todayISO();
      editAppointmentType.value = rec.appointmentType || '';
      editCategory.value = rec.category || '';
      editPdf.value = '';
      toggleEditModal(true);
    }
    editCancel.addEventListener('click', () => toggleEditModal(false));
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = editId.value;
      const rec = await dbGetById(id); if (!rec) return showToast('Registro não encontrado.', 'error');

      const newName = editPatientName.value.trim();
      const newDate = editAppointmentDate.value;
      const newType = editAppointmentType.value;
      const newCat = editCategory.value;
      const newPdf = editPdf.files[0];

      if (!newName || !newDate || !newType || !newCat) return alert('Preencha todos os campos.');

      if (newPdf) {
        const isPdf = (newPdf.type === 'application/pdf') || newPdf.name.toLowerCase().endsWith('.pdf');
        if (!isPdf) return alert('Apenas PDF.');
        if (!ENC.key) return alert('Desbloqueie com a senha para continuar.');
        const buf = new Uint8Array(await newPdf.arrayBuffer());
        const enc = await encryptBytes(buf);
        rec.fileBlob = new Blob([enc.ct], { type: 'application/octet-stream' });
        rec.fileIv = b64(enc.iv);
        rec.fileName = newPdf.name;
        rec.fileMime = 'application/pdf';
      }

      rec.patientName = newName; rec.appointmentDate = newDate; rec.appointmentType = newType; rec.category = newCat;

      try { await dbUpdateRecord(rec); toggleEditModal(false); showToast('Prontuário atualizado!'); await displayRecords(); }
      catch (err) { console.error(err); showToast('Erro ao atualizar: ' + (err?.message || err), 'error'); }
    });

    /* ====================== EXPORTAR/IMPORTAR ZIP + PASTA DE BACKUP ===================== */
    async function pickBackupDir() {
      if (!window.showDirectoryPicker) { alert('Navegador sem suporte a pasta de backup.'); return; }
      try {
        backupDirHandle = await showDirectoryPicker();
        await settingsSet('backupDirHandle', backupDirHandle);
        showToast('Pasta de backup configurada.');
      } catch (e) { console.error(e); showToast('Não foi possível configurar a pasta.', 'error'); }
    }
    async function exportToDir(blob, fileName) {
      if (!backupDirHandle) return false;
      try {
        const fileHandle = await backupDirHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        return true;
      } catch (e) { console.error(e); return false; }
    }
    btnBackupDir?.addEventListener('click', pickBackupDir);

    btnExport.addEventListener('click', async () => {
      try {
        const all = await dbGetAll(); if (!all.length) return showToast('Não há registros para exportar.', 'error');
        const zip = new JSZip();
        const meta = all.map(r => ({
          id: r.id, patientName: r.patientName, appointmentDate: r.appointmentDate,
          appointmentType: r.appointmentType, category: r.category, fileName: r.fileName,
          fileMime: r.fileMime || 'application/pdf', fileIv: r.fileIv || null, createdAt: r.createdAt, deletedAt: r.deletedAt || null
        }));
        zip.file('metadata.json', JSON.stringify({ encrypted: true, exportedAt: new Date().toISOString(), count: all.length, items: meta }, null, 2));
        for (const r of all) {
          if (r.fileBlob) {
            const ab = await r.fileBlob.arrayBuffer();
            const safe = String(r.fileName || 'arquivo.bin').replace(/[\\/:*?"<>|]/g, '_');
            zip.file(`files/${r.id}__${safe}.bin`, ab);
          }
        }
        const content = await zip.generateAsync({ type: 'blob' });
        const fileName = `prontuarios_backup_${new Date().toISOString().slice(0, 10)}.zip`;
        if (backupDirHandle) {
          const saved = await exportToDir(content, fileName);
          if (saved) { showToast('Backup exportado na pasta configurada.'); return; }
        }
        const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = fileName;
        document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(a.href), 2000);
        showToast('Backup exportado!');
      } catch (e) { console.error(e); showToast('Falha ao exportar backup.', 'error'); }
    });

    inputImport.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try {
        const zip = await JSZip.loadAsync(file);
        const metaFile = zip.file('metadata.json'); if (!metaFile) throw new Error('metadata.json ausente');
        const meta = JSON.parse(await metaFile.async('string'));
        const restored = [];
        const encryptedZip = !!meta.encrypted;

        for (const item of (meta.items || [])) {
          const safeBase = `${item.id}__${String(item.fileName).replace(/[\\/:*?"<>|]/g,'_')}`;
          const fileEntry = encryptedZip
            ? zip.file(`files/${safeBase}.bin`)
            : (zip.file(`files/${safeBase}`) || zip.file(`files/${safeBase}.pdf`));

          const ab = fileEntry ? await fileEntry.async('arraybuffer') : null;
          let blob = null, ivB64 = item.fileIv || null;

          if (ab) {
            if (encryptedZip) {
              blob = new Blob([ab], { type: 'application/octet-stream' });
            } else {
              if (!ENC.key) return alert('Desbloqueie com a senha para importar backup legado.');
              const enc = await encryptBytes(new Uint8Array(ab));
              blob = new Blob([enc.ct], { type: 'application/octet-stream' });
              ivB64 = b64(enc.iv);
            }
          }

          const exists = await dbGetById(item.id);
          const rec = {
            id: exists ? (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + '-' + Math.random().toString(16).slice(2)) : item.id,
            patientName: item.patientName,
            appointmentDate: item.appointmentDate,
            appointmentType: item.appointmentType,
            category: item.category,
            fileName: item.fileName,
            fileMime: item.fileMime || 'application/pdf',
            fileIv: ivB64,
            fileBlob: blob,
            createdAt: item.createdAt || new Date().toISOString(),
            deletedAt: item.deletedAt || null
          };
          await dbAddRecord(rec); restored.push(rec.id);
        }

        showToast(`Importados ${restored.length} registro(s)`); await displayRecords();
      } catch (e2) { console.error(e2); showToast('Falha ao importar backup.', 'error'); }
      finally { e.target.value = ''; }
    });

  </script>
</body>
</html>
